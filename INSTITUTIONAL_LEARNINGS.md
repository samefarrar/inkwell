# Institutional Learnings: Focus Edit Mode & Related Features

**Generated**: 2026-02-19
**Source**: Comprehensive plan review from `/docs/plans/` and `/docs/brainstorms/`

---

## Document Overview

This document consolidates all institutional knowledge and design patterns already documented for:
- **Focus Edit Mode** (single-draft editing with inline suggestions)
- **AI Sidebar / Editorial Collaboration**
- **Inline Suggestions & Track Changes**
- **TipTap Editor Customization**
- **WebSocket Streaming Patterns**
- **Editorial Feedback System**

These sections contain **solved design decisions**, **technical patterns**, and **acceptance criteria** from the existing project plans. Reference these before implementation to avoid duplicating work and follow established patterns.

---

## 1. Focus Edit Mode: Complete Design

### Source
- **Plan**: `docs/plans/2026-02-16-feat-mvp-ai-writing-partner-plan.md` (Phase 5)
- **Status**: Designed, not yet implemented

### Overview

Focus Edit Mode is the **fifth screen** in the Inkwell workflow. It's accessed by clicking "Focus on this" on any draft during the highlighting phase. It provides a **single-draft, full-width editing experience** modeled on **Proof.app's collaboration pattern** (NOT a grammar checker).

The core principle: **two types of editorial feedback, presented as sidebar components:**

1. **Inline Suggestions** â€” Track-change style edits (accept/reject)
2. **Editorial Comments** â€” Advisory structural feedback (read and dismiss)

### Two Feedback Types

#### Inline Suggestions (Deterministic)
- Generated by a **rule-based style engine** (no LLM call)
- **Visual**: Green underline (insertion), red strikethrough (deletion)
- **Interaction**: Hover/click to show tooltip (original â†’ replacement + explanation)
  - Accept button: applies replacement in TipTap, removes mark, sends `focus.feedback` (accept)
  - Reject button: removes mark, sends `focus.feedback` (reject)
- **Speed**: Returns within 100ms for typical documents
- **Learning**: Each accept/reject feedback updates rule confidence scores in the flywheel

#### Editorial Comments (LLM-Driven)
- Generated by an **LLM editorial pass** (2-3s latency)
- **Visual**: Subtle yellow/orange highlight on quoted text
- **Content**: "Consider adding a concrete example here", "This transition is abrupt", "Show, don't tell"
- **Interaction**: Click to open margin popover showing comment + category tag (structure/voice/clarity/impact)
  - Dismiss button: removes comment, signals engagement to flywheel
- **Scope**: Not accept/reject â€” these are advisory, user edits manually
- **Context**: Uses interview history + style examples to assess draft quality

### Key Design Principle
**No category filter pills** (grammar, spelling, punctuation, style). Instead: clean sidebar split (**Suggestions** tab vs **Comments** tab). This matches how a human editor works.

### Architecture

```
FocusEditor (main container)
â”œâ”€â”€ TipTap Editor (editable, full-width)
â”‚   â”œâ”€â”€ SuggestionMark (inline green/red underlines)
â”‚   â””â”€â”€ CommentMark (subtle yellow highlights)
â””â”€â”€ FocusSidebar (right side, two tabs)
    â”œâ”€â”€ Suggestions Tab
    â”‚   â”œâ”€â”€ List of pending suggestions
    â”‚   â”œâ”€â”€ Count badge on tab header
    â”‚   â”œâ”€â”€ Click item â†’ scroll & highlight in editor
    â”‚   â””â”€â”€ [Accept] [Reject] per item
    â””â”€â”€ Comments Tab
        â”œâ”€â”€ List of editorial comments
        â”œâ”€â”€ Quote snippet + category tag + comment preview
        â”œâ”€â”€ Click item â†’ scroll to commented text
        â””â”€â”€ [Dismiss] per item
```

### UI Styling (from Editorial Darkroom)

**FocusEditor container:**
- Full-width editor against dark chrome background
- TipTap editor on warm paper background (`--paper` color)
- Minimal toolbar: bold, italic, headers, lists, link (no font picker, color picker)
- Word count in footer
- Authorship indicator (like Proof: "Human 62% / AI 38%")

**Inline marks:**
- Suggestions: `text-decoration: underline wavy` (green for insertions, red for deletions)
- Comments: `background: rgba(232, 115, 58, 0.1)` (subtle orange highlight)

**FocusSidebar:**
- Right sidebar, two tabs (Suggestions / Comments)
- Paper-colored background for consistency
- Each item shows quote snippet (truncated), action buttons
- Clicking item scrolls to location in editor (using TipTap `scrollIntoView`)

### Analysis Trigger Strategy

- **Entry**: Auto-run style engine (instant) + editorial LLM (async) when user enters focus mode
- **Idle**: Debounced re-analysis after user stops typing for 3 seconds (style engine only â€” editorial comments don't re-run on every keystroke)
- **After edit**: Re-run style engine on changed paragraph only (optimization)

### Acceptance Criteria

- [ ] Full-width TipTap editor with minimal toolbar (bold, italic, headers, lists, link)
- [ ] Green-underlined inline suggestions appear for style violations (accept/reject)
- [ ] Yellow-highlighted editorial comments appear for structural guidance (read/dismiss)
- [ ] Right sidebar shows both Suggestions and Comments tabs
- [ ] Clicking suggestion/comment in sidebar scrolls to location in editor
- [ ] Accept/reject/dismiss actions send `focus.feedback` to backend and update learning flywheel
- [ ] Style analysis returns within 500ms
- [ ] Feels like working with a human editor, not a grammar checker

---

## 2. Inline Suggestions & Track Changes

### Source
- **Plan**: `docs/plans/2026-02-16-feat-mvp-ai-writing-partner-plan.md` (Phase 5)

### Backend: Style Engine

The **Style Engine** is deterministic and rule-based â€” no LLM. It runs fast (<100ms).

#### Architecture

**File**: `backend/src/proof_editor/style/engine.py`

```python
class StyleViolation:
    quote: str                    # Original text
    replacement: str              # Suggested text
    explanation: str              # Why (for user tooltip)
    rule_id: str                  # Which rule fired
    confidence: float             # 0.0â€“1.0, adjusted by learning flywheel

async def analyze(text: str) -> list[StyleViolation]:
    """Deterministic style checks against Every Write Style Guide."""
    # Returns violations in order of appearance in text
```

#### Built-in Rules

Pre-implemented rule modules in `backend/src/proof_editor/style/rules/`:

1. **oxford_comma.py** â€” Detect missing Oxford commas in lists
2. **passive_voice.py** â€” Flag passive constructions ("was written" â†’ "wrote")
3. **filler_words.py** â€” Flag "actually", "very", "just", "really"
4. **numbers.py** â€” Enforce: spell out 1-9, numerals for 10+
5. **em_dash.py** â€” Check spacing around em-dashes, max 2 per paragraph
6. **title_case.py** â€” Check headline formatting
7. **active_links.py** â€” Flag "click here" link text, suggest descriptive text

#### Rule Confidence Filtering

- All rules start at confidence 1.0
- When user rejects a suggestion, that rule's confidence **decreases**
- Backend filters violations below confidence threshold (0.3) before sending to frontend
- Feedback from `focus.feedback` messages updates confidence scores

#### REST Endpoint

**Endpoint**: `POST /api/analyze`

```
Request:
{
  "text": "Full draft text",
  "session_id": 1
}

Response:
{
  "suggestions": [StyleViolation, ...],
  "comments": [EditorialComment, ...]   // Streamed after suggestions
}
```

- Style violations are **instant** (rule engine)
- Editorial comments may take 2-3s (LLM call)
- **Supports streaming**: Send suggestions immediately, then comments when LLM finishes

### Frontend: Inline Marks

#### TipTap Extensions Needed

```typescript
// Existing
import { Highlight } from '@tiptap/extension-highlight'

// New
import { Collaboration } from '@tiptap/extension-collaboration'  // Enables suggestion marks

// Custom marks
import SuggestionMark from './marks/SuggestionMark'
import CommentMark from './marks/CommentMark'
```

#### SuggestionMark Component

```typescript
// frontend/src/lib/components/SuggestionMark.svelte

type SuggestionMark {
  id: string
  quote: string
  replacement: string
  explanation: string
  rule_id: string
  confidence: float
  type: "insert" | "delete"  // Determines styling
}

// Render inline in TipTap editor
// On hover: tooltip shows [original] â†’ [replacement] + explanation + buttons
// Accept: applies replacement, removes mark, sends focus.feedback("accept")
// Reject: removes mark, sends focus.feedback("reject")
```

**Styling:**
- Insert (addition): green underline, green highlight on hover
- Delete (removal): red strikethrough, red highlight on hover
- Tooltip: small popup adjacent to mark, with buttons

#### CommentMark Component

```typescript
// frontend/src/lib/components/CommentMark.svelte

type CommentMark {
  id: string
  quote: string
  comment: string
  category: "structure" | "voice" | "clarity" | "impact"
}

// Render as subtle background highlight in editor
// On click: margin popover (right side) shows full comment + [Dismiss] button
// Dismiss: removes comment, sends focus.feedback("dismiss")
```

**Styling:**
- Background: `rgba(232, 115, 58, 0.1)` (subtle orange)
- Category tag: small colored badge (structure=blue, voice=purple, clarity=green, impact=orange)

### WebSocket Messages

**Type**: `FocusSuggestion` (server â†’ client)
```python
class FocusSuggestion(BaseModel):
    type: Literal["focus.suggestion"] = "focus.suggestion"
    id: str                    # Unique suggestion ID
    quote: str                 # Original text (for matching in editor)
    replacement: str           # Suggested replacement
    explanation: str           # Tooltip text
    rule_id: str              # Which rule fired
    confidence: float         # 0.0â€“1.0
```

**Type**: `FocusComment` (server â†’ client)
```python
class FocusComment(BaseModel):
    type: Literal["focus.comment"] = "focus.comment"
    id: str                    # Unique comment ID
    quote: str                 # Text being commented on
    comment: str               # Editorial guidance text
    category: str              # "structure" | "voice" | "clarity" | "impact"
```

**Type**: `FocusFeedback` (client â†’ server)
```python
class FocusFeedback(BaseModel):
    type: Literal["focus.feedback"] = "focus.feedback"
    id: str                    # Suggestion or comment ID
    action: Literal["accept", "reject", "dismiss"]
```

---

## 3. Editorial Sidebar

### Source
- **Plan**: `docs/plans/2026-02-16-feat-mvp-ai-writing-partner-plan.md` (Phase 5)

### Component: FocusSidebar

**File**: `frontend/src/lib/components/FocusSidebar.svelte`

```svelte
<FocusSidebar>
  <Tabs>
    <Tab name="Suggestions" count={6}>
      <!-- List of pending style suggestions -->
      {#each suggestions as sugg}
        <SuggestionItem {sugg} />
      {/each}
    </Tab>
    <Tab name="Comments" count={3}>
      <!-- List of editorial comments -->
      {#each comments as comment}
        <CommentItem {comment} />
      {/each}
    </Tab>
  </Tabs>
</FocusSidebar>
```

### Suggestions Tab

Each item shows:
- **Quote snippet** (truncated to 60 chars, ellipsis if longer)
- **Rule name** (e.g., "Filler words", "Passive voice")
- **[Accept]** and **[Reject]** buttons

**Interaction:**
- Clicking the quote scrolls to and highlights the suggestion in the editor
- Clicking [Accept] applies the replacement, removes the mark, sends `focus.feedback("accept")`
- Clicking [Reject] removes the mark, sends `focus.feedback("reject")`
- Count badge on tab header shows pending count

### Comments Tab

Each item shows:
- **Quote snippet** (truncated)
- **Category tag** (structure/voice/clarity/impact, different colors)
- **Comment preview** (first 80 chars)
- **[Dismiss]** button (no accept/reject)

**Interaction:**
- Clicking the quote scrolls to the commented text in the editor
- Clicking [Dismiss] removes the comment, sends `focus.feedback("dismiss")`

### Design Details

**Sidebar styling:**
- Width: ~280px fixed on desktop, slides out on mobile
- Background: `--paper` color for consistency with Editorial Darkroom
- Border: `1px solid var(--paper-border)`
- Tab headers: Outfit 600, small caps, accent color when active

**Tab styling:**
- Underline indicator (accent color) on active tab
- Count badge: small circle with number, only shown if count > 0
- Hover: slight background highlight

**Item styling:**
- Padding: 12px 16px
- Border: `1px solid var(--paper-border)`
- Border-radius: 8px
- Hover: `border-color: var(--accent)`
- Quote text: truncated with ellipsis, `font-family: 'Newsreader', serif`

### Scroll-to-Location

When user clicks a suggestion/comment item:
1. Get the `quote` text from the item
2. Find the mark in TipTap editor with matching quote
3. Call `scrollIntoView()` on that node
4. Optional: temporarily highlight/pulse the mark (visual feedback)

---

## 4. TipTap Editor Customization

### Source
- **Plan**: `docs/plans/2026-02-16-feat-mvp-ai-writing-partner-plan.md` (Phase 5)
- **CLAUDE.md**: FocusEditor.svelte specification

### Core Setup

**Extensions:**
```typescript
import StarterKit from '@tiptap/starter-kit'
import Highlight from '@tiptap/extension-highlight'
import Collaboration from '@tiptap/extension-collaboration'  // For suggestion marks
import SuggestionMark from './marks/SuggestionMark'
import CommentMark from './marks/CommentMark'

const editor = new Editor({
  extensions: [
    StarterKit,
    Highlight,
    Collaboration,
    SuggestionMark,
    CommentMark,
  ],
  editable: true,
  content: draftContent,
})
```

### Minimal Toolbar

**Allowed buttons only:**
- Bold
- Italic
- Heading (H1, H2, H3)
- Bullet list
- Ordered list
- Link

**NOT included:**
- Font picker
- Color picker
- Underline (reserved for suggestions)
- Strikethrough (reserved for deletions)

### Editor Styling

**Font**: `font-family: 'Newsreader', serif` (matching drafts)
**Size**: `17px`, `line-height: 1.75`
**Color**: `--ink`
**Background**: `--paper`

**Content area:**
- Max-width: 680px (readable column width)
- Margin: 40px auto (centered)
- Padding: 40px (breathing room)

### Authorship Indicator

Footer element showing:
```
Human 62% / AI 38%
```

Calculated as:
- Count user-edited sentences vs total sentences
- Show as percentage badge

### Focus Mode Entry State

When user clicks "Focus on this" from DraftComparison:
1. Load selected draft content into TipTap editor
2. Automatically run `POST /api/analyze` with the draft text
3. Show loading state while analysis is running
4. As results arrive:
   - Insert suggestion marks immediately
   - Insert comment marks when editorial LLM finishes
5. Populate FocusSidebar with counts

---

## 5. WebSocket Streaming Patterns

### Source
- **Plan**: `docs/plans/2026-02-16-feat-mvp-ai-writing-partner-plan.md` (Phase 1)
- **CLAUDE.md**: WebSocket Protocol section

### Core Flow

All WebSocket communication is **typed** via Pydantic models in `ws_types.py`. The backend generates these types, and the frontend mirrors them as TypeScript.

### Draft Streaming

**Current pattern** (already implemented for DraftComparison):

```python
# Server sends DraftStart, then multiple DraftChunk messages
DraftStart(draft_index=0, title="Hook First", angle="Narrative-driven")
DraftChunk(draft_index=0, content="The morning...", done=False)
DraftChunk(draft_index=0, content=" Sarah sat at her desk", done=False)
DraftChunk(draft_index=0, content=" with coffee in hand.", done=True)
DraftComplete(draft_index=0, word_count=1452)
```

**For Focus Edit**: Same pattern applies when entering focus mode with a synthesized draft.

### Analysis Streaming

**New pattern** (for style analysis):

```python
# Server sends style suggestions immediately
FocusSuggestion(id="sugg_1", quote="very important", replacement="important", ...)
FocusSuggestion(id="sugg_2", quote="was written", replacement="wrote", ...)

# Then, after LLM finishes, sends comments
FocusComment(id="comm_1", quote="In the first paragraph", comment="Consider adding...", ...)
FocusComment(id="comm_2", quote="The hook", comment="This is compelling but...", ...)
```

This mimics how real editors work: instant mechanical fixes, then thoughtful commentary.

### Session Cancellation

**New message type** (for sidebar navigation):

```python
class SessionCancel(BaseModel):
    type: Literal["session.cancel"] = "session.cancel"
```

When user switches sessions via sidebar, frontend sends:
1. `session.cancel` â€” aborts in-flight LLM calls on backend
2. `session.resume` â€” resumes the new session

Backend maintains `_active_tasks: list[asyncio.Task]` on the Orchestrator and cancels them on `session.cancel`.

### Message Versioning / Session ID Tagging

**Pattern** (from Phase 7 of sidebar plan):

Tag all serverâ†’client messages with `session_id` to prevent stale messages from corrupting UI on rapid session switches:

```python
class DraftChunk(BaseModel):
    type: Literal["draft.chunk"] = "draft.chunk"
    session_id: int            # NEW FIELD
    draft_index: int
    content: str
    done: bool = False

# Frontend discards messages where session_id !== currentSessionId
```

Apply this pattern to **all serverâ†’client messages** for robustness (Phase 7, though marked deferred for MVP).

---

## 6. Learning Flywheel Integration

### Source
- **Plan**: `docs/plans/2026-02-16-feat-mvp-ai-writing-partner-plan.md` (Phase 6)

### Feedback Recording

Every `focus.feedback` message feeds the learning system:

```python
# backend/src/proof_editor/learning/flywheel.py

def record_feedback(
    session_id: int,
    suggestion_id: str,
    rule_id: str,
    action: Literal["accept", "reject"],
    quote: str,
    replacement: str,
):
    """Store feedback for rule confidence adjustment."""
    # 1. Save feedback to database
    # 2. Update rule confidence: if accept, increase; if reject, decrease
    # 3. Use in future analysis passes

def get_rule_confidence(rule_id: str) -> float:
    """Return current confidence for a rule based on accept/reject history."""
    # Confidence ranges 0.0â€“1.0
    # Heavily rejected rules can drop to 0.1â€“0.3
    # Rules with high accept rate stay at 0.9+

def get_style_preferences() -> dict:
    """Aggregated preferences from all feedback across all sessions."""
    # E.g., {
    #   "user_prefers_short_sentences": True,
    #   "user_prefers_concrete_examples": True,
    #   "user_dislikes_passive_voice": True,
    # }

def get_highlighted_favorites() -> list[str]:
    """Phrases/sentences the user has highlighted as "like" across sessions."""
    # Used as few-shot examples in future draft generation
```

### Rule Confidence Filtering

Before sending suggestions to frontend, filter by confidence:

```python
violations = await analyze(text)
# Filter: only keep violations with confidence >= threshold (0.3)
high_confidence_violations = [
    v for v in violations if v.confidence >= 0.3
]
```

### Learning Indicator (UI)

**Subtle footer indicator** (not intrusive):
```
ðŸ§  Learning from your preferences
```

Shown in FocusEditor footer as a small badge, disappears when sidebar is visible (sidebar is the "main" UI).

---

## 7. Editorial Darkroom Design System

### Source
- **Plan**: `docs/plans/2026-02-17-feat-editorial-darkroom-ui-redesign-plan.md`

### CSS Variables

All colors and spacing are defined as CSS variables in `:root`. Use these consistently across focus edit components:

```css
:root {
  /* Chrome (dark workspace) */
  --chrome: #1a1a1e;
  --chrome-surface: #26262b;
  --chrome-border: #38383d;
  --chrome-text: #e4e4e7;
  --chrome-text-muted: #71717a;

  /* Paper (warm reading surfaces) */
  --paper: #faf8f5;
  --paper-surface: #f3f0eb;
  --paper-border: #e2ddd5;

  /* Ink (text on paper) */
  --ink: #2c2418;
  --ink-secondary: #7a7062;
  --ink-muted: #a8a090;

  /* Accent */
  --accent: #e8733a;
  --accent-glow: rgba(232, 115, 58, 0.15);
  --accent-soft: #f4a574;

  /* Semantic */
  --success: #4ade80;
  --thought-bg: #2d2822;
  --thought-border: #4a3f2f;
}
```

### Typography

- **UI elements**: `font-family: 'Outfit', sans-serif` (geometric sans)
- **Draft content & editing**: `font-family: 'Newsreader', serif` (editorial serif)

### Border Radius Scale

| Size | Use |
|------|-----|
| 20px | Pill buttons (Start, Accept, Reject) |
| 16px | Large containers (sidebar, editor panel) |
| 12px | Cards (suggestion items, comment items) |
| 10px | Small cards |
| 8px | Small buttons, popovers, tooltip |
| 6px | Tiny controls, accent highlight box |

### Transitions

| Element | Duration |
|---------|----------|
| Buttons, controls | 0.15s |
| Cards, borders | 0.2s |
| Sidebar appearance | 0.2s ease-out |
| Mark highlight/unhighlight | 0.15s |

---

## 8. Implementation Checklist

### Phase 5 (Focus Edit): Full Spec

**Backend:**
- [ ] Create `backend/src/proof_editor/style/engine.py` with `analyze()` function
- [ ] Create rule modules in `backend/src/proof_editor/style/rules/`:
  - [ ] `oxford_comma.py`
  - [ ] `passive_voice.py`
  - [ ] `filler_words.py`
  - [ ] `numbers.py`
  - [ ] `em_dash.py`
  - [ ] `title_case.py`
  - [ ] `active_links.py`
- [ ] Create `backend/src/proof_editor/style/editor.py` for LLM-driven editorial comments
- [ ] Create REST endpoint `POST /api/analyze` with streaming support
- [ ] Add WebSocket message types: `FocusSuggestion`, `FocusComment`, `FocusFeedback`
- [ ] Write tests: `tests/test_style/` for each rule

**Frontend:**
- [ ] Create `frontend/src/lib/components/FocusEditor.svelte`
- [ ] Create `frontend/src/lib/components/SuggestionMark.svelte`
- [ ] Create `frontend/src/lib/components/CommentMark.svelte`
- [ ] Create `frontend/src/lib/components/FocusSidebar.svelte`
- [ ] Integrate TipTap extensions: Highlight, Collaboration, custom marks
- [ ] Add scroll-to-location logic (click sidebar item â†’ scroll to mark in editor)
- [ ] Handle debounced re-analysis on idle (3-second delay)
- [ ] Display learning indicator in footer

### Phase 6 (Learning Flywheel): Integration

- [ ] Create `backend/src/proof_editor/learning/flywheel.py`
- [ ] Implement rule confidence calculation and filtering
- [ ] Hook `focus.feedback` messages into flywheel recording
- [ ] Test confidence adjustments via accept/reject cycles

---

## 9. Key Design Decisions Already Made

1. **Two feedback types** â€” Inline suggestions (accept/reject) vs editorial comments (read/dismiss). No category filter pills.

2. **Proof.app model, not grammar checker** â€” Focus edit feels like collaboration with a human editor, not automated corrections.

3. **Instant suggestions + async comments** â€” Style engine is deterministic and fast (<100ms). Editorial comments via LLM are slower (2-3s) but provide depth.

4. **Sidebar over inline popover** â€” FocusSidebar (two-tab) is cleaner than scattered tooltips for managing multiple feedback items.

5. **Rule confidence learning** â€” Rejected rules decrease in confidence and eventually disappear (won't suggest what the user rejects).

6. **Full-width, minimal toolbar editor** â€” TipTap editor is focused on writing, not formatting. No font/color pickers.

7. **No "Focus on synthesized draft"** â€” User can focus on any of the 3 original drafts OR a synthesized draft. Access via "Focus on this" button, not a separate screen.

---

## 10. Common Gotchas to Avoid

### WebSocket Streaming

- **Gotcha**: If suggestion/comment marks arrive before the editor DOM is ready, they won't attach to the text nodes properly.
- **Mitigation**: Wait for TipTap editor to be fully mounted before sending WebSocket messages with marks. Use `onMount()` callback.

### TipTap Custom Marks

- **Gotcha**: Custom marks must follow ProseMirror's spec (`parseDOM`, `toDOM`, `addAttributes`). If not, text won't render.
- **Mitigation**: Test mark attachment with simple text first (e.g., hardcoded suggestion in a test). Verify `quote` text exactly matches text in editor.

### Scroll-to-Location

- **Gotcha**: Searching for `quote` text with `.find()` or regex can match multiple locations (e.g., repeated phrases). User clicks "The hook" and scrolls to the first mention, not the one being commented on.
- **Mitigation**: Store mark's TipTap node position (`pos`) in the message, or use mark ID + TipTap's `find()` method to locate node by ID.

### Analysis Re-run Performance

- **Gotcha**: Running full style analysis on every keystroke tanks performance. User types one character, 50 rules run, UI freezes.
- **Mitigation**: Debounce analysis to 3-second idle (from spec). Only re-run style engine on changed paragraph, not whole document. Editorial comments don't re-run on keystroke (only on mode entry).

### Rule Confidence Thresholds

- **Gotcha**: If threshold (0.3) is too low, old rejected rules still fire. If too high, legitimate rules disappear.
- **Mitigation**: Start all rules at 1.0 confidence. Log all accept/reject actions to understand distribution before adjusting threshold. Plan post-launch tuning.

### Learning Flywheel Integration

- **Gotcha**: Forgetting to pass `session_id` in `focus.feedback` messages means feedback isn't tied to the right session, and learning doesn't compound.
- **Mitigation**: Include `session_id` in all feedback records. Validate `session_id` matches current session before applying learning.

---

## 11. References

- **MVP Plan**: `/docs/plans/2026-02-16-feat-mvp-ai-writing-partner-plan.md` (Phase 5 & 6)
- **Editorial Darkroom Design**: `/docs/plans/2026-02-17-feat-editorial-darkroom-ui-redesign-plan.md`
- **Sidebar + Voice Plan**: `/docs/plans/2026-02-18-feat-inkwell-rebrand-sidebar-voice-styles-plan.md`
- **Brainstorm**: `/docs/brainstorms/2026-02-16-mvp-brainstorm.md`
- **CLAUDE.md**: Architecture overview and build commands

---

## Quick Start

To implement focus edit mode efficiently:

1. **Read Phase 5 (Focus Edit)** in the MVP plan thoroughly â€” all technical specs are there
2. **Reference the Editorial Darkroom CSS variables** for styling consistency
3. **Start with the style engine** (backend) â€” implement 2-3 rules, test them
4. **Then build FocusEditor + FocusSidebar** (frontend) â€” connect to style engine via `/api/analyze`
5. **Add editorial comments** (backend + frontend) â€” LLM pass on top of suggestions
6. **Wire in learning flywheel** â€” record feedback, adjust rule confidence

This order ensures working parts build incrementally and testing is straightforward.
