#!/usr/bin/env bash
# dev â€” start/stop/restart the Proof Editor dev servers
# Usage: ./dev [start|stop|restart|status|logs]
set -euo pipefail

ROOT="$(cd "$(dirname "$0")" && pwd)"
PID_DIR="$ROOT/.dev-pids"
LOG_DIR="$ROOT/.dev-logs"
BACKEND_PORT=8000
FRONTEND_PORT=5173

mkdir -p "$PID_DIR" "$LOG_DIR"

# --- helpers ---

_kill_port() {
  local port=$1
  local pids
  pids=$(lsof -ti :"$port" 2>/dev/null || true)
  if [[ -n "$pids" ]]; then
    echo "$pids" | xargs kill -9 2>/dev/null || true
    sleep 0.3
  fi
}

_is_running() {
  local name=$1
  local pidfile="$PID_DIR/$name.pid"
  [[ -f "$pidfile" ]] && kill -0 "$(cat "$pidfile")" 2>/dev/null
}

_start_backend() {
  if _is_running backend; then
    echo "backend already running (pid $(cat "$PID_DIR/backend.pid"))"
    return
  fi
  _kill_port "$BACKEND_PORT"

  # Source .env for ANTHROPIC_API_KEY etc.
  if [[ -f "$ROOT/.env" ]]; then
    set -a
    # shellcheck disable=SC1091
    source "$ROOT/.env"
    set +a
  fi

  cd "$ROOT/backend"
  uv run python -m proof_editor \
    > "$LOG_DIR/backend.log" 2>&1 &
  local pid=$!
  echo "$pid" > "$PID_DIR/backend.pid"
  echo "backend started (pid $pid, port $BACKEND_PORT)"
}

_start_frontend() {
  if _is_running frontend; then
    echo "frontend already running (pid $(cat "$PID_DIR/frontend.pid"))"
    return
  fi
  _kill_port "$FRONTEND_PORT"

  cd "$ROOT/frontend"
  npm run dev -- --port "$FRONTEND_PORT" --strictPort \
    > "$LOG_DIR/frontend.log" 2>&1 &
  local pid=$!
  echo "$pid" > "$PID_DIR/frontend.pid"
  echo "frontend started (pid $pid, port $FRONTEND_PORT)"
}

_stop_one() {
  local name=$1
  local pidfile="$PID_DIR/$name.pid"
  if [[ -f "$pidfile" ]]; then
    local pid
    pid=$(cat "$pidfile")
    # Kill the process group to catch child processes (uvicorn workers, vite)
    kill -- -"$pid" 2>/dev/null || kill "$pid" 2>/dev/null || true
    rm -f "$pidfile"
    echo "$name stopped"
  else
    echo "$name not running"
  fi
}

_stop_all() {
  _stop_one backend
  _stop_one frontend
  # Belt-and-suspenders: also kill anything lingering on the ports
  _kill_port "$BACKEND_PORT"
  _kill_port "$FRONTEND_PORT"
}

_status() {
  for name in backend frontend; do
    if _is_running "$name"; then
      echo "$name: running (pid $(cat "$PID_DIR/$name.pid"))"
    else
      echo "$name: stopped"
      rm -f "$PID_DIR/$name.pid"
    fi
  done
}

_logs() {
  local name="${1:-}"
  if [[ -n "$name" && -f "$LOG_DIR/$name.log" ]]; then
    tail -f "$LOG_DIR/$name.log"
  else
    tail -f "$LOG_DIR/backend.log" "$LOG_DIR/frontend.log"
  fi
}

# --- main ---

cmd="${1:-start}"

case "$cmd" in
  start)
    _start_backend
    _start_frontend
    echo ""
    echo "Backend:  http://localhost:$BACKEND_PORT"
    echo "Frontend: http://localhost:$FRONTEND_PORT"
    echo "Logs:     ./dev logs"
    ;;
  stop)
    _stop_all
    ;;
  restart)
    _stop_all
    sleep 0.5
    _start_backend
    _start_frontend
    echo ""
    echo "Backend:  http://localhost:$BACKEND_PORT"
    echo "Frontend: http://localhost:$FRONTEND_PORT"
    ;;
  status)
    _status
    ;;
  logs)
    _logs "${2:-}"
    ;;
  *)
    echo "Usage: ./dev [start|stop|restart|status|logs [backend|frontend]]"
    exit 1
    ;;
esac
